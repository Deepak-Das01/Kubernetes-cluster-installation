helm upgrade -i monitoring prometheus-community/kube-prometheus-stack \
  -n monitoring --create-namespace \
  --values - <<'VALUES'
grafana:
  enabled: false

defaultRules:
  create: true

# Enable core component monitors (safe defaults)
kubeApiServer:        { enabled: true }
kubeControllerManager:{ enabled: true }
kubeScheduler:        { enabled: true }
kubeProxy:            { enabled: true }
coreDns:              { enabled: true }
kubeEtcd:             { enabled: false }   # enable later if you expose etcd metrics
kubelet:
  enabled: true
  serviceMonitor:
    cAdvisor: true
    probes: true
    resource: true

kube-state-metrics:
  enabled: true

prometheus-node-exporter:
  enabled: true

alertmanager:
  enabled: true
  service:
    type: NodePort
    nodePort: 30993
    port: 9093
  alertmanagerSpec:
    retention: 120h
    storage:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
  # Starter config; add email/Slack later
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname','namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'null'
      routes:
      - matchers: [ alertname = "Watchdog" ]
        receiver: 'null'
    receivers:
    - name: 'null'

prometheus:
  service:
    type: NodePort
    nodePort: 30990
    port: 9090
  prometheusSpec:
    retention: 15d
    scrapeInterval: "30s"
    evaluationInterval: "30s"
    enableAdminAPI: true
    # pick up ServiceMonitor/PodMonitor from any namespace
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi
    resources:
      requests:
        cpu: "200m"
        memory: "1Gi"
      limits:
        cpu: "2"
        memory: "3Gi"
VALUES
